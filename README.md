# MLOps

## 1. 머신러닝 파이프라인의 이해
### 1-1. 머신러닝 파이프라인의 필요성
- 생산성 향상
- 예측 가능한 품질
- 장애 대응능력 향상

> ML 시스템 개발 및 배포는 비교적 쉽고 빠르지만 해당 시스템을 유지하고 관리하는 비용은 매우 크다.

----

### 1-2. 머신러닝 문제의 특징
1) 쉬운 머신러닝 문제
    - 데이터의 변화가 slow (분기, 월 단위)
    - 모델 재학습이 다음에 의해 발생
        - 더 많은 데이터로 모델 성능 개선
        - 소프트웨어 혹은 시스템의 변화
    - 레이블링
        - 수집한 데이터
        - 크라우드 소싱
2) 어려운 머신러닝 문제
    - 데이터의 변화가 fast (주 단위 이하)
    - 모델 재학습이 다음에 의해 발생
        - 더 많은 데이터로 모델 성능 개선
        - 소프트웨어 혹은 시스템의 변화
        - **모델 성능 저하**
    - 레이블링
        - 수집한 데이터
        - 크라우드 소싱
        - **직접적인 피드백**

> ML은 본질적으로 실험
> 여러 사항을 변경 적용해봄으로써 최적의 솔루션을 찾는 것이 관건
> 항목별 효과 정도를 추적하고 코드 재사용을 극대화하며 재현성을 유지해야함

- ML 시스템에서의 테스팅과 배포는 SW 시스템에 비해 복잡하고 어려움
- ML 모델은 코딩뿐만 아니라 지속적으로 발생하는 Data Profile 탓에 성능 저하가 일어날 수 있음
    - 따라서 데이터의 통계피를 추적하고 모델의 온라인 성능을 모니터링하여 예상치를 벗어날 때 알림 발송 혹은 롤백이 필요

----

### 1-3. MLOps의 핵심 문제
1) 모델 학습 / 배포 Trigger
머신러닝 시스템은 다음과 같은 상황에서 모델의 학습과 배포를 수행
    - 요청 시: 파이프라인의 임시 수동 실행
    - 일정 기준: 레이블이 지정된 새 데이터는 매일, 매주 혹은 매월
    - 새로운 학습 데이터: 새 데이터가 들어오는 경우 모델의 재학습을 트리거
    - 모델 성능 저하시: 성능 저하가 눈에 띄는 경우 모델 재학습
    - 데이터 분포의 중요한 변화(Concept Drift)
        - 온라인 모델의 전체 성능을 평가하기는 어렵지만 예측을 수행하는 데 사용되는 feature의 데이터 분포에 큰 변화가 있다면, 모델이 오래되었음을 의미

2) 진화하는 데이터셋과 Metric
- CI/CD -> CT(Continuous Training)

----

### 1-4. MLOps 성숙도 레벨
1) MLOps 성숙도 레벨 0
- 수동, 스크립트 중심, 대화식(Interactive) 프로세스
- ML과 운영의 분리
- 드문 릴리즈 반복
- CI 없음
- CD 없음
- 배포 == 예측 서비스 그 자체
- Active 성능 모니터링의 부족
![image](https://user-images.githubusercontent.com/76294398/137730858-e155c8e9-8f8c-4fad-b37c-33b6dc88c42b.png)

<br>

2) MLOps 성숙도 레벨 1
- 빠른 실험
- 프로덕션 모델의 CT
- 실험 운영 환경의 조화
- 구성 요소 및 파이프라인을 위한 모듈화된 코드
- 지속적인 모델 제공
- 파이프라인 배포
![image](https://user-images.githubusercontent.com/76294398/137731065-ac02c284-0f34-4a56-b07c-f86467c3e0c5.png)

<br>

3) MLOps 성숙도 레벨 2
- Production에서 파이프라인의 빠르고 안정적인 업데이트를 위한 자동화된 CI/CD 시스템
- 자동화된 CI/CD 시스템을 통한 Feature Engineering, 모델 아키텍쳐 및 Hyper Parameter의 Opimization
![image](https://user-images.githubusercontent.com/76294398/137731484-fa5e4845-d74e-4df7-bf51-4971c009e77c.png)

<br>

---

## 2. 머신러닝 파이프라인 단계
### 2-1. 머신러닝 파이프라인 단계 개요
머신러닝 파이프라인은 새로운 학습 데이터를 수집하는 것으로 시작하여
새로 학습된 모델이 어떻게 작동하고 있는지에 대한 피드백을 받는 것으로
끝난다. 이 피드백은 프로덕션 성능 메트릭 또는 제품 사용자의
피드백일 수 있다.

![image](https://user-images.githubusercontent.com/76294398/137916029-358c30df-46de-4071-820d-570e9fa565ad.png)

<br>

---

### 2-2. 데이터 수집, 버전 관리, 데이터 검증
1) Data Ingetion / Versioning
- 일반적으로, 데이터의 양이 많으면 모델의 성능이 개선된다. 따라서 지속적인 데이터 유입 및 버전관리가 필요하며, 재학습의 자동화가 필요할 수 있다.
- 그렇지 않을 경우 모델이 예측하고자 하는 데이터와 학습 데이터의 괴리로 인해 정확도가 저하될 수 있다.

<br>

2) Data Validation
- 머신러닝 시스템에서는 데이터로 인한 장애의 파악이 어렵다. 따라서 새로운 버전의 모델을 학습하기 전 데이터의 검증이 필요한데, 이는 새로운 데이터의 통계적 분포가 예상대로인지 확인하고, 이상 징후가 발견될 경우 알람을 제공하는 과정 등을 포함할 수 있다.

- 대표적으로, 분류 문제에서의 데이터 레이블 불균형 문제는 성능에 심각한 저하를 초래할 수 있으므로 주의해야 하고, 이를 감지하는 과정이 자동화 되어 있어야 실수를 줄일 수 있으며, 리소스 소모를 최소화 할 수 있다.

<br>

3) Data preprocessing
-Raw data는 머신러닝 모델에 input으로 바로 사용되지 못할 확률이 크다. 이를 모델 학습에 사용할 수 있는 형태로 바꾸는 작업이 전처리 과정이다.
- 전처리는 모든 학습 epoch마다 실행될 필요는 없으며 모델 학습 전에 처리되면 되므로 모델 학습 직전 단계에서 전처리를 실행하는 것이 가장 합리적이다.
- 전처리 과정의 변경은 전체 파이프라인의 업데이트를 야기할 수 있으므로 신중하게 구성하는 것이 바람직하다.

<br>

---
 
### 2-3. 모델 학습, 모델 분석, 모델 버전 관리
1) Model training
- 머신러닝 파이프라인의 핵심으로, 보통 오차를 줄이는 방향으로 발전한다.
- 대규모 데이터를 운영할 경우 한정된 메모리를 효율적으로 사용하기 위한 모델 훈련의 효율적 분포가 중요하다.

<br>

2) Model tuning
- 모델 튜닝은 상당한 성능 개선과 경쟁 우위를 제공할 수 있어 최근 각광 받고 있다.
- 머신러닝 파이프라인을 고려하기 전에 모델을 튜닝하도록 설정하거나 파이프라인의 일부를 이용하여 튜닝하는 것이 바람직하다.
- Hyper Parameter Optimization이 이 과정에 속한다.

<br>

3) Model analysis
- 일반적으로 정확도 또는 loss를 사용하여 최적의 모형 모수 집합을 결정한다. 모델의 최종 버전을 결정한 후에는 모델의 성능에 대해 보다 심층적으로 분석하는 것이 유용하다.
- accuracy, recall, AUC 등의 다양한 metric을 이용해 계산하거나 학습에 사용되는 validation set보다 더 큰 데이터셋에서 test를 수행하는 등의 작업을 포함한다.
- 모델 분석을 심층적으로 하는 이유는 모형의 예측이 공정하다는 것을 확인하기 위해서이다.

<br>

---

### 2-4. 모델 배포, 피드백 루프 반복, 개인정보 보호